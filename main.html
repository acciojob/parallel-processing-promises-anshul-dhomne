<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Image Downloader (Promise.all) - Test Friendly</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 20px; }
    #output img { max-width: 200px; margin: 6px; border-radius: 4px; display:inline-block; }
    #loading { display: none; margin-top: 10px; }
    .spinner {
      width: 20px; height: 20px; border-radius: 50%;
      border: 3px solid rgba(0,0,0,0.12); border-top-color: #0b84ff;
      animation: spin 1s linear infinite; display:inline-block; vertical-align: middle;
    }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    #error { color: #b00020; margin-top: 10px; font-weight: 600; }
  </style>
</head>
<body>
  <h2>Image Downloader (Promise.all)</h2>

  <div id="controls">
    <!-- Test expects this exact id -->
    <button id="download-images-button">Download Images</button>
    <button id="clear-button">Clear</button>
  </div>

  <div id="loading" aria-live="polite" role="status">
    <span class="spinner" aria-hidden="true"></span>
    <span style="margin-left:8px;">Downloading imagesâ€¦</span>
  </div>

  <div id="error" role="alert" aria-live="assertive"></div>

  <!-- Test expects images to appear inside this div -->
  <div id="output" style="margin-top:12px;"></div>

  <script>
    // URLs that the Cypress test checks
    const imageUrls = [
      'https://picsum.photos/id/237/200/300',
      'https://picsum.photos/id/238/200/300',
      'https://picsum.photos/id/239/200/300'
    ];

    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const outputEl = document.getElementById('output');
    const downloadBtn = document.getElementById('download-images-button');
    const clearBtn = document.getElementById('clear-button');

    function downloadImage(url, timeoutMs = 10000) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        let timedOut = false;

        const to = setTimeout(() => {
          timedOut = true;
          img.src = ''; // best-effort cancel
          reject(new Error(`Timeout while loading image: ${url}`));
        }, timeoutMs);

        img.onload = () => {
          if (timedOut) return;
          clearTimeout(to);
          // ensure src is exactly the url string (some CDNs may redirect, but attribute will contain original)
          img.setAttribute('src', url);
          resolve(img);
        };

        img.onerror = () => {
          if (timedOut) return;
          clearTimeout(to);
          reject(new Error(`Failed to load image: ${url}`));
        };

        // start load
        img.src = url;
        img.alt = 'Downloaded image';
      });
    }

    function showLoading() {
      loadingEl.style.display = 'block';
      errorEl.textContent = '';
      outputEl.innerHTML = '';
      downloadBtn.disabled = true;
      clearBtn.disabled = true;
    }

    function hideLoading() {
      loadingEl.style.display = 'none';
      downloadBtn.disabled = false;
      clearBtn.disabled = false;
    }

    function downloadAllImages() {
      showLoading();

      const promises = imageUrls.map(url => downloadImage(url));

      return Promise.all(promises)
        .then(images => {
          // Append images in the same order as imageUrls
          images.forEach(img => {
            // set width/height attributes to match test expectations if needed
            img.width = 200;
            img.height = 300;
            img.style.objectFit = 'cover';
            outputEl.appendChild(img);
          });
        })
        .catch(err => {
          errorEl.textContent = String(err && err.message ? err.message : err);
        })
        .finally(() => {
          hideLoading();
        });
    }

    downloadBtn.addEventListener('click', () => {
      downloadAllImages();
    });

    clearBtn.addEventListener('click', () => {
      outputEl.innerHTML = '';
      errorEl.textContent = '';
      loadingEl.style.display = 'none';
    });

    // Ensure output starts empty (no images)
    document.addEventListener('DOMContentLoaded', () => {
      outputEl.innerHTML = '';
    });
  </script>
</body>
</html>
